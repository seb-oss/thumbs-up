<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/all.min.css" />
    <script>
      const pageUrl = "certificates";
      const apiBaseUrl = "http://localhost:5000";
      const frontendBaseUrl = "http://localhost:5500";
      function deleteThumb(pageUrl) {
        fetch(`${apiBaseUrl}/thumbs?pageUrl=${pageUrl}`, {
          method: "DELETE",
          credentials: "include"
        })
          .then(res => res.json())
          .then(setElements);
      }
      function setThumb(pageUrl, userThumb) {
        fetch(`${apiBaseUrl}/thumbs`, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            pageUrl,
            userThumb
          })
        })
          .then(res => res.json())
          .then(setElements);
      }
      function clearListeners(elementId) {
        const thumbsUpElement = document.getElementById(elementId);
        const elClone = thumbsUpElement.cloneNode(true);
        thumbsUpElement.parentNode.replaceChild(elClone, thumbsUpElement);
      }
      function getThumbState(selectedUserThumb) {
        if (selectedUserThumb === "thumbUp") {
          return {
            active: { cssSelector: "thumb-up", thumb: "thumbUp" },
            inactive: { cssSelector: "thumb-down", thumb: "thumbDown" }
          };
        } else {
          return {
            active: { cssSelector: "thumb-down", thumb: "thumbDown" },
            inactive: { cssSelector: "thumb-up", thumb: "thumbUp" }
          };
        }
      }

      function setElements(res) {
        clearListeners("thumb-up");
        clearListeners("thumb-down");
        const thumbsUpElement = document.getElementById("thumb-up");
        const thumbsDownElement = document.getElementById("thumb-down");

        if (res.userThumb) {
          const state = getThumbState(res.userThumb);
          const activeThumb = document.getElementById(state.active.cssSelector);
          const inactiveThumb = document.getElementById(
            state.inactive.cssSelector
          );
          inactiveThumb.classList.remove("selected");
          activeThumb.classList.add("selected");
          activeThumb.addEventListener("click", () => deleteThumb(pageUrl));
          inactiveThumb.addEventListener("click", () =>
            setThumb(pageUrl, state.inactive.thumb)
          );
        } else {
          thumbsUpElement.classList.remove("selected");
          thumbsDownElement.classList.remove("selected");
          document
            .getElementById("thumb-up")
            .addEventListener("click", () => setThumb(pageUrl, "thumbUp"));
          thumbsDownElement.addEventListener("click", () =>
            setThumb(pageUrl, "thumbDown")
          );
        }
        document.getElementById("thumb-total").textContent =
          res.thumbsUp - res.thumbsDown;
      }
      if (!document.cookie.includes("token")) {
        window.location.href = `${apiBaseUrl}/authorize?redirect_uri=${frontendBaseUrl}`;
      }
      fetch(`${apiBaseUrl}/thumbs?pageUrl=${pageUrl}`, {
        credentials: "include"
      })
        .then(res => res.json())
        .then(setElements);
    </script>
  </head>
  <body>
    <div id="thumbs-container">
      <i
        id="thumb-up"
        class="thumb-item thumb fad fa-thumbs-up fa-flip-horizontal"
      ></i>
      <i id="thumb-down" class="thumb-item thumb fad fa-thumbs-down "></i>
      <p id="thumbs-total" class="thumb-item"></p>
    </div>
  </body>
</html>
