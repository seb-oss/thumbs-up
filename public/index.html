<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/all.min.css" />
    <script>
      const pageUrl = location.search.substr(1).split("=")[1];

      function deleteThumb(pageUrl) {
        fetch(`/thumbs?pageUrl=${pageUrl}`, {
          method: "DELETE",
          credentials: "include"
        })
          .then(res => res.json())
          .then(setElements);
      }

      function setThumb(pageUrl, clickedThumb) {
        fetch(`/thumbs`, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            pageUrl,
            userThumb: clickedThumb === "thumb-up" ? "thumbUp" : "thumbDown"
          })
        })
          .then(res => res.json())
          .then(setElements);
      }

      function getThumbs() {
        fetch(`/thumbs?pageUrl=${pageUrl}`, {
          credentials: "include"
        })
          .then(res => res.json())
          .then(setElements);
      }

      function clearListeners(elementId) {
        const thumbsUpElement = document.getElementById(elementId);
        const elClone = thumbsUpElement.cloneNode(true);
        thumbsUpElement.parentNode.replaceChild(elClone, thumbsUpElement);
      }

      function getThumbState(selectedUserThumb) {
        if (selectedUserThumb === "thumbUp") {
          return {
            active: "thumb-up",
            inactive: "thumb-down"
          };
        } else {
          return {
            active: "thumb-down",
            inactive: "thumb-up"
          };
        }
      }

      function setElements(res) {
        clearListeners("thumb-up");
        clearListeners("thumb-down");
        const thumbsUpElement = document.getElementById("thumb-up");
        const thumbsDownElement = document.getElementById("thumb-down");

        if (res.userThumb) {
          const state = getThumbState(res.userThumb);
          const activeThumb = document.getElementById(state.active);
          const inactiveThumb = document.getElementById(state.inactive);
          inactiveThumb.classList.remove("selected");
          activeThumb.classList.add("selected");
          activeThumb.addEventListener("click", () => deleteThumb(pageUrl));
          inactiveThumb.addEventListener("click", () =>
            setThumb(pageUrl, state.inactive)
          );
        } else {
          thumbsUpElement.classList.remove("selected");
          thumbsDownElement.classList.remove("selected");
          document
            .getElementById("thumb-up")
            .addEventListener("click", () => setThumb(pageUrl, "thumb-up"));
          thumbsDownElement.addEventListener("click", () =>
            setThumb(pageUrl, "thumb-down")
          );
        }
        document.getElementById("thumbs-total").textContent =
          res.thumbsUp - res.thumbsDown;
      }

      if (!document.cookie.includes("token")) {
        window.location.href = `${apiBaseUrl}/authorize?redirect_uri=${frontendBaseUrl}`;
      }
      getThumbs();
    </script>
  </head>
  <body>
    <div id="thumbs-container">
      <i
        id="thumb-up"
        class="thumb-item thumb fad fa-thumbs-up fa-flip-horizontal"
      ></i>
      <i id="thumb-down" class="thumb-item thumb fad fa-thumbs-down "></i>
      <p id="thumbs-total" class="thumb-item"></p>
    </div>
  </body>
</html>
