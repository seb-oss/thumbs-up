<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/all.min.css" />
    <script>
      const pageId = location.search.substr(1).split("=")[1];

      function deleteThumb(pageId) {
        fetch(`/thumbs?pageId=${pageId}`, {
          method: "DELETE",
          credentials: "include"
        })
          .then(res => res.json())
          .then(setElements);
      }

      function setThumb(pageId, clickedThumb) {
        fetch(`/thumbs`, {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            pageId,
            userThumb: clickedThumb === "thumb-up" ? "thumbUp" : "thumbDown"
          })
        })
          .then(res => res.json())
          .then(setElements);
      }

      function getThumbs() {
        fetch(`/thumbs?pageId=${pageId}`, {
          credentials: "include"
        })
          .then(res => res.json())
          .then(setElements);
      }

      function clearListeners(elementId) {
        const thumbsUpElement = document.getElementById(elementId);
        const elClone = thumbsUpElement.cloneNode(true);
        thumbsUpElement.parentNode.replaceChild(elClone, thumbsUpElement);
      }

      function getThumbState(selectedUserThumb) {
        if (selectedUserThumb === "thumbUp") {
          return {
            active: "thumb-up",
            inactive: "thumb-down"
          };
        } else {
          return {
            active: "thumb-down",
            inactive: "thumb-up"
          };
        }
      }

      function setElements(res) {
        clearListeners("thumb-up");
        clearListeners("thumb-down");
        const thumbsUpElement = document.getElementById("thumb-up");
        const thumbsDownElement = document.getElementById("thumb-down");

        if (res.userThumb) {
          const state = getThumbState(res.userThumb);
          const activeThumb = document.getElementById(state.active);
          const inactiveThumb = document.getElementById(state.inactive);
          inactiveThumb.classList.remove("selected");
          activeThumb.classList.add("selected");
          activeThumb.addEventListener("click", () => deleteThumb(pageId));
          inactiveThumb.addEventListener("click", () =>
            setThumb(pageId, state.inactive)
          );
        } else {
          thumbsUpElement.classList.remove("selected");
          thumbsDownElement.classList.remove("selected");
          document
            .getElementById("thumb-up")
            .addEventListener("click", () => setThumb(pageId, "thumb-up"));
          thumbsDownElement.addEventListener("click", () =>
            setThumb(pageId, "thumb-down")
          );
        }
        document.getElementById("thumbs-total").textContent =
          res.thumbsUp - res.thumbsDown;
      }
      document.addEventListener("DOMContentLoaded", () => {
        if (!document.cookie.includes("token")) {
          const loginBtn = document.getElementById("login-btn");
          loginBtn.classList.remove("hidden");
          loginBtn.setAttribute(
            "href",
            `/authorize?redirect_uri=${document.location.origin}`
          );
        } else {
          getThumbs();
        }
      });
    </script>
  </head>
  <body>
    <div id="main-container">
      <div id="thumbs-container">
        <i
          id="thumb-up"
          class="thumb-item thumb fad fa-thumbs-up fa-flip-horizontal"
        ></i>
        <i id="thumb-down" class="thumb-item thumb fad fa-thumbs-down "></i>
        <p id="thumbs-total" class="thumb-item">0</p>
      </div>
      <a id="login-btn" class="btn hidden">Sign in to vote</a>
    </div>
  </body>
</html>
